# EVCS 配置文件功能说明

## 概述

EVCS 1.2.0 版本优化了配置文件功能，简化了时间配置逻辑，直接使用具体秒数替代动态时间变量，提升了性能和可维护性。

## 新增功能

### 1. 配置文件系统
- **默认配置文件**：`config/default.ini`
- **支持格式**：标准 INI 文件格式
- **字符编码**：UTF-8
- **自动加载**：程序启动时自动加载默认配置

### 2. 菜单项

#### 文件菜单
- **加载配置文件(&L)...**：打开文件选择对话框，加载指定的 INI 配置文件
- **重新加载配置(&R)**：重新加载当前配置文件或默认配置文件

## 配置文件格式（简化版）

### INI 文件结构

```ini
; 每个科目直接定义自己的配置和指令列表

[语文]
duration=150
-720=考前12分钟|1kq12.wav
-600=考前10分钟|2kq10.wav
-300=考前5分钟|3kq5.wav
0=开始考试|4ksks.wav
8100=结束前15分钟|5jsq15.wav
9000=考试结束|6ksjs.wav

[数学]
duration=120
-720=考前12分钟|1kq12.wav
-600=考前10分钟|2kq10.wav
-300=考前5分钟|3kq5.wav
0=开始考试|4ksks.wav
6300=结束前15分钟|5jsq15.wav
7200=考试结束|6ksjs.wav

[英语]
duration=120
-720=考前12分钟|1kq12.wav
-600=考前10分钟|2kq10.wav
-540=听力试音|sy.mp3
-300=考前5分钟|3kq5.wav
0=开始考试|4ksks.wav
20=听力|tl.mp3
6300=结束前15分钟|5jsq15.wav
7200=考试结束|6ksjs.wav
```

### 配置格式说明

#### 科目配置节
每个科目一个独立的配置节：

- **节标题**：`[科目名称]` - 直接使用科目名称作为节标题
- **科目信息行**：`duration=时长(分钟)`
- **指令行**：`时间偏移(秒)=指令名称|音频文件`

#### 配置参数

##### 科目信息
- **duration**：考试持续时间，单位为分钟

##### 指令定义
- **时间偏移**：相对于考试开始时间的秒数，负数表示考试开始前
- **指令名称**：显示在界面中的指令描述
- **音频文件**：对应的音频文件名（放在audio目录下）

#### 配置简化说明
- 移除了 `double` 参数，不再需要指定是否为双场考试
- 移除了动态时间变量，直接使用具体秒数
- 考试类型完全由科目名称和指令列表本身定义
- 配置更加简洁直观，专注于实际的指令内容

## 技术实现

### 核心组件

#### ConfigManager 类
- **单例模式**：全局唯一的配置管理器
- **文件解析**：支持 UTF-8 编码的 INI 文件解析
- **直接秒数**：使用具体的秒数值，无需复杂计算
- **错误处理**：完整的错误检测和报告机制

#### 配置加载流程
1. 程序启动时自动加载默认配置
2. 用户可通过菜单加载其他配置文件
3. 配置更新后自动重新生成指令列表

### 新增文件

1. **src/ConfigManager.h**：配置管理器头文件
2. **src/ConfigManager.cpp**：配置管理器实现文件
3. **config/default.ini**：默认配置文件

## 使用说明

### 1. 自定义配置
1. 复制 `config/default.ini` 为新的配置文件
2. 修改配置文件中的科目和指令设置
3. 通过 "文件 → 加载配置文件" 菜单加载自定义配置

### 2. 添加新科目
1. 在配置文件中添加新的 `[科目名称]` 节
2. 设置科目时长：`duration=时长(分钟)`
3. 定义指令列表：`时间偏移(秒)=指令名称|音频文件`

### 3. 修改指令序列
1. 找到对应的科目配置节
2. 修改时间偏移（使用具体秒数）、指令名称或音频文件
3. 时间偏移计算：考试结束前X分钟 = (duration - X) × 60 秒

## 注意事项

1. **文件编码**：配置文件必须使用 UTF-8 编码保存
2. **路径分隔符**：音频文件路径使用 `/` 作为分隔符
3. **时间单位**：所有时间偏移以秒为单位
4. **配置验证**：程序会自动验证配置文件的完整性和正确性
5. **备份建议**：修改配置前建议备份原始文件

## 错误处理

- **配置文件不存在**：程序将自动创建默认配置文件
- **配置格式错误**：程序会显示详细的错误信息
- **加载失败**：程序会保持使用之前的配置，不会中断运行

## 兼容性

- **向后兼容**：支持原有的静态配置方式
- **配置优先级**：动态配置文件优先于静态配置
- **回退机制**：配置加载失败时自动回退到默认配置